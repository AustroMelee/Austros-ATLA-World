# Core System Policies

This document outlines the mandatory policies, rules, and best practices that govern the development of this system. Adherence to these policies is required for all contributions.

## Core Policies
### 10.1. Plug-and-Play Compliance Policy (MANDATORY)
- All new features, content, and mechanics must be implemented in a strictly plug-and-play fashion.
- No hard-coded references to specific entities (characters, moves, etc.) are allowed in core logic.
- All extensible entities must be registered via explicit registries and referenced by ID.
- Adding new content must never require changes to core engine, AI, or narrative code.
- Any PR or commit that violates this policy must be rejected or refactored before merge.

### 10.2. Logging Architecture Policy
- All battle log entries are strictly separated by type.
- All engine sub-phases must return log entries to be appended only in processTurn.
- UI components must filter and render logs based on their type.
- See the Logging System Guide for full details.

### 10.3. Test/Mock Data Policy
- All test data should be isolated and clearly marked. Mock data should accurately reflect the shape of real data types.

### 10.4. Security, Privacy, and Dependency Management
- Regularly audit dependencies for vulnerabilities.
- No sensitive data should ever be stored in the codebase or logs.
- Follow a clear versioning and change management process for all updates.

## Technical Enforcement Policies
### Log Pipeline & Type-Safety Best Practices (2025)
- **Contract-first changes:** Any new log field/type change must ship with a red-green test and an ESLint rule. ADRs must include a “compile-time guarantees” section.
- **Single-source branding:** All branded utility types (e.g., NonEmptyString) must live only in types/index.ts. No redeclaration in other modules. Enforced by eslint-plugin-import rule no-internal-redeclare.
- **Discriminated unions for logs:** Dialogue logs (type: 'dialogue') must require an actor (fighter name); all other log types must not allow a fighter actor.
- **Runtime guards:** All logs must be validated at runtime: no empty strings, every log must have a turn, and all fields must pass type assertions.
- **CI “canary” simulation:** CI must run a long AI-vs-AI battle and fail on the first malformed log entry.
- **Pre-commit enforcement:** lint-staged must run npm run lint -- --max-warnings=0 and vitest --run on all touched files. No PR may merge with lint or test failures.
- **Reference:** See /docs/error-reports/Error Report - July 9th 2025.md for the full post-mortem and rationale.

### Anti-Stalemate, Escalation, and Narrative Log Enforcement (2025-07)
- All escalation, desperation, and forced ending code paths must strictly enforce move pool restrictions: AI cannot select basic or repetitive moves in escalation or desperation phases.
- If no escalation/desperation/finisher move is available, the battle must end immediately with a forced ending (never a draw or endless loop).
- Every escalation, desperation, and forced ending event must append at least one narrative or dialogue log to the main battleLog array (not just technical logs).
- All log creation must use branded, type-safe helpers (logStory, logDialogue, logTechnical) and be appended to the main log array for UI rendering.
- Test coverage must assert that every turn and every battle outcome includes at least one narrative or dialogue log.
- **July 9th, 2025 Overhaul:**
  - Dramatic/finisher/last-resort move pools expanded for all characters.
  - Move selection logic guarantees dramatic moves in escalation/desperation/climax.
  - Penalty logic ensures dramatic moves are always available.
  - Narrative pools expanded to 8–10 unique lines per phase/character, with fallback to contextual lines.
  - Global anti-repetition and cadence logic: at least one dialogue/scene line every 2 turns in dramatic phases.
  - Forced endings always output unique, cinematic lines.
  - All changes are type/lint/test enforced, with robust error handling and test coverage.

## Onboarding: Unused/Legacy File Policy
- All orphaned/unused files are listed in UNUSED_FILES_REPORT.md, auto-generated by CI.
- Every flagged file must have a rationale or @legacy tag in its header.
- Do not use or resurrect files flagged as @legacy or listed in the report without consulting the project architect.
- Before merging, confirm the checklist:
  - Not imported anywhere (static/dynamic analysis)
  - No runtime references or dynamic loading
  - Superseded file is live and covered by tests
  - Changelog/GitHub issue updated
  - Team notified

## Lessons Learned
### Branded String Hygiene & Log Actor Enforcement
A multi-batch, repo-wide effort in July 2025 enforced strict branded string hygiene (NonEmptyString/nes) and log actor rules (no actor on non-dialogue logs). Key takeaways:
- All branded string fields require nes(...) for runtime/type safety.
- Only dialogue logs may have an actor; all others must not.
- Test data must use canonical helpers and match type requirements.
- All repo-wide type/log changes must use codemods, with scripts and docs in /codemods/.
- CI and pre-commit hooks enforce lint/type/test/doc sync; never merge with errors.
- Documentation and ALL_FILES_INDEX.md must be updated in every batch.

For full details, see docs/error-reports/Error Report - July 10th 2025.md.
