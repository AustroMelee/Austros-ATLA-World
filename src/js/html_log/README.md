# HTML Log Module

## Overview

The HTML Log module is a specialized utility responsible for converting the structured `battleLog` array, generated by the engine, into a human-readable HTML format. It processes a sequence of event objects and builds a semantic HTML string that can be displayed in the UI to show the user a play-by-play of the battle.

This module is designed as a stateful builder. It iterates through events, managing the opening and closing of `<section>` tags for turns and phases to ensure the final output is well-formed.

## Architectural Constraints

- This is a utility module that is primarily used by the `UI` layer.
- It can have dependencies on `/data` (to look up character names) and other `/utils`.
- It should **not** have dependencies on `engine`, `ai`, or `css`.

## Module Interaction

```mermaid
graph TD
    A[UI Layer] --> B{HTML Log Module}
    C[Battle Log (Array)] --> B
    B --> D[HTML String]

    subgraph HTML Log Module
        E[builder.js]
        F[event_handlers.js]
        G[html_generators.js]
        H[state.js]
    end

    A -- "Build Log" --> E
    E --> F & G & H

    D --> A
```
- **UI Layer**: The UI calls the `HtmlLogBuilder` to generate the HTML for the battle log display.
- **Battle Log**: The builder takes the raw `battleLog` array as input.
- **HTML String**: The builder produces a single HTML string as output, which the UI then injects into the DOM.

## Files

-   **`builder.js`**: Contains the main `HtmlLogBuilder` class. This class orchestrates the entire process, holding the state and calling the other modules to process events and generate HTML.
-   **`event_handlers.js`**: Responsible for routing events to the correct logic. The `processEvent` function uses a `switch` statement to handle different event types, such as `turn_marker` and `phase_header_event`, which require special handling for grouping.
-   **`html_generators.js`**: Contains functions that generate the actual HTML strings for individual log entries. `getEventHtml` is the main function, which can either use pre-formatted `html_content` from an event or generate new HTML for specific types like dice rolls.
-   **`state.js`**: Manages the state of the builder, specifically which `div` or `section` tags are currently open. Functions like `closeCurrentTurnDiv` and `ensureTurnGroupOpen` are crucial for ensuring the final HTML is well-formed.
-   **`utils.js`**: Provides helper and factory functions for the module, such as `buildHtmlLog` for a one-off conversion without needing to instantiate the class directly.

## Usage

The `ui.js` module would use this system to render the battle log after a simulation is complete.

```javascript
import { HtmlLogBuilder } from './js/html_log/builder.js';

// Assume 'battleResult.log' is the array of event objects from a battle
function renderBattleLog(battleLogEvents) {
    const logContainer = document.getElementById('battle-log-container');

    if (!logContainer) return;

    // Create an instance of the builder
    const logBuilder = new HtmlLogBuilder();

    // Build the HTML string from the event log
    const html = logBuilder.build(battleLogEvents);

    // Inject the generated HTML into the DOM
    logContainer.innerHTML = html;
} 